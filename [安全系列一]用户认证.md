## 目录
* [认证组件源码简单介绍](#认证组件简单介绍源码)
* [identityClass简单源码介绍](#identityClass简单源码介绍)
* [用户信息注册进认证组件源码](#用户信息注册进认证组件源码)
* [不注册直接从认证组件获取用户信息源码](#不注册直接从认证组件获取用户信息源码)

# 认证组件源码简单介绍
yii封装了一个用户认证类，该类是一个可以在配置文件web.php中配置的组件  
默认配置如下
```
'components' => [
  ...
  'user' => [
      'identityClass' => 'app\models\User',
      'enableAutoLogin' => true,
  ],
  ...
]
```
认证组件的class属性在入口文件执行底层base\Application合并
```
foreach ($this->coreComponents() as $id => $component) {
    if (!isset($config['components'][$id])) {
        $config['components'][$id] = $component;
    } elseif (is_array($config['components'][$id]) && !isset($config['components'][$id]['class'])) {
        $config['components'][$id]['class'] = $component['class'];
    }
}
```
所以默认的配置为
```
'components' => [
  ...
  'user' => [
      'class' => 'yii\web\User',
      'identityClass' => 'app\models\User',
      'enableAutoLogin' => true,
  ],
  ...
]
```
yii\web\User继承Component，所以可以使用属性注入、事件和行为  
```
class User extends Component
{
    const EVENT_BEFORE_LOGIN = 'beforeLogin';
    const EVENT_AFTER_LOGIN = 'afterLogin';
    const EVENT_BEFORE_LOGOUT = 'beforeLogout';
    const EVENT_AFTER_LOGOUT = 'afterLogout';
```
可用的属性注入有  
```
protected function getAccessChecker()
protected function getAuthManager()
protected function getIdentityAndDurationFromCookie()
public function setReturnUrl($url)
public function getReturnUrl($defaultUrl = null)
public function getId()
public function getIsGuest()
public function setIdentity($identity)
public function getIdentity($autoRenew = true)
```
需要注意的是user组件有init方法，这个方法是底层方法，就是执行完构造函数后会由底层直接调用 
```
public function init()
{
    parent::init();
    //是否有认证逻辑类
    if ($this->identityClass === null) {
        throw new InvalidConfigException('User::identityClass must be set.');
    }
    //如果用cookie存信息的话，需要有cookie相关的属性
    if ($this->enableAutoLogin && !isset($this->identityCookie['name'])) {
        throw new InvalidConfigException('User::identityCookie must contain the "name" element.');
    }
    if (!empty($this->accessChecker) && is_string($this->accessChecker)) {
        $this->accessChecker = Yii::createObject($this->accessChecker);
    }
}
```
# identityClass简单源码介绍
User组件有一个核心属性是identityClass，identityClass类其实就是获取用户信息，一般都会封装成和数据库关联的，从数据库直接获取用户信息，为了方便起见我们使用yii安装后的默认identitiyClass属性app\models\User  
值得注意的是，identityClass必须实现接口IdentityInterface  
默认的identityClass内部源码非常简单  
```
private static $users = [
    '100' => [
        'id' => '100',
        'username' => 'admin',
        'password' => 'admin',
        'authKey' => 'test100key',
        'accessToken' => '100-token',
    ],
    '101' => [
        'id' => '101',
        'username' => 'demo',
        'password' => 'demo',
        'authKey' => 'test101key',
        'accessToken' => '101-token',
    ],
];
//通过id获取用户信息，就是静态user属性的key
public static function findIdentity($id)
{
    return isset(self::$users[$id]) ? new static(self::$users[$id]) : null;
}
//通过accessToken获取用户信息
public static function findIdentityByAccessToken($token, $type = null)
{
    foreach (self::$users as $user) {
        if ($user['accessToken'] === $token) {
            return new static($user);
        }
    }

    return null;
}
//通过用户名获取用户属性，默认是不区分大小写的
public static function findByUsername($username)
{
    foreach (self::$users as $user) {
        if (strcasecmp($user['username'], $username) === 0) {
            return new static($user);
        }
    }

    return null;
}
//判断authKey是否一致
public function validateAuthKey($authKey)
{
    return $this->authKey === $authKey;
}
//判断密码是否一致
public function validatePassword($password)
{
    return $this->password === $password;
}
```
# 用户信息注册进认证组件源码
先从用户登录开始，控制器代码如下  
```
class TestController extends Controller{
  public function actionD(){
      $user = Yii::$app->get("user");
      //使用安装yii后默认的models\User
      $identity = $user->identityClass::findIdentity(101);
      //将用户信息注册进用户认证
      $user->login($identity);
  }
}
```
login方法的源码如下  
```
public function login(IdentityInterface $identity, $duration = 0)
{
    //执行beforeLogin事件，根据事件的isValid来判断是否可以登录
    if ($this->beforeLogin($identity, false, $duration)) {
        //将旧的用户认证信息从会话中删除，并且可选的是重新将authTimeoutParam、absoluteAuthTimeoutParam生存周期存进会话
        $this->switchIdentity($identity, $duration);
        //获取认证id
        $id = $identity->getId();
        //从request组件中获取客户端ip
        $ip = Yii::$app->getRequest()->getUserIP();
        //就是日志信息会有所不同
        if ($this->enableSession) {
            $log = "User '$id' logged in from $ip with duration $duration.";
        } else {
            $log = "User '$id' logged in from $ip. Session not enabled.";
        }
        //重新更新csrf
        $this->regenerateCsrfToken();
        //存日志
        Yii::info($log, __METHOD__);
        //执行登录后事件
        $this->afterLogin($identity, false, $duration);
    }
    //判断登录认证信息是否可用，也就是是否登录成功了
    return !$this->getIsGuest();
}
```
用户注册登录认证的时候，会有以下操作  
- 原有cookie中的认证信息删除(可选)  
- 更新session_id(可选)  
- 从session中删除__id和__expire属性  
- 重新从当前时间开始存authTimeoutParam和absoluteAuthTimeoutParam(可选)  
- 将认证信息存进cookie(可选)  
