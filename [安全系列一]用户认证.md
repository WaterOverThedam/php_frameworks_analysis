## 目录
* [认证组件源码简单介绍](#认证组件简单介绍源码)
* [identityClass简单源码介绍](#identityClass简单源码介绍)
* [用户信息注册进认证组件源码](#用户信息注册进认证组件源码)
* [不注册直接从认证组件获取用户信息源码](#不注册直接从认证组件获取用户信息源码)

# 认证组件源码简单介绍
yii封装了一个用户认证类，该类是一个可以在配置文件web.php中配置的组件  
默认配置如下
```
'components' => [
  ...
  'user' => [
      'identityClass' => 'app\models\User',
      'enableAutoLogin' => true,
  ],
  ...
]
```
认证组件的class属性在入口文件执行底层base\Application合并
```
foreach ($this->coreComponents() as $id => $component) {
    if (!isset($config['components'][$id])) {
        $config['components'][$id] = $component;
    } elseif (is_array($config['components'][$id]) && !isset($config['components'][$id]['class'])) {
        $config['components'][$id]['class'] = $component['class'];
    }
}
```
所以默认的配置为
```
'components' => [
  ...
  'user' => [
      'class' => 'yii\web\User',
      'identityClass' => 'app\models\User',
      'enableAutoLogin' => true,
  ],
  ...
]
```
yii\web\User继承Component，所以可以使用属性注入、事件和行为  
```
class User extends Component
{
    const EVENT_BEFORE_LOGIN = 'beforeLogin';
    const EVENT_AFTER_LOGIN = 'afterLogin';
    const EVENT_BEFORE_LOGOUT = 'beforeLogout';
    const EVENT_AFTER_LOGOUT = 'afterLogout';
```
可用的属性注入有  
```
protected function getAccessChecker()
protected function getAuthManager()
protected function getIdentityAndDurationFromCookie()
public function setReturnUrl($url)
public function getReturnUrl($defaultUrl = null)
public function getId()
public function getIsGuest()
public function setIdentity($identity)
public function getIdentity($autoRenew = true)
```
# identityClass简单源码介绍
User组件有一个核心属性是identityClass，identityClass类其实就是获取用户信息，一般都会封装成和数据库关联的，从数据库直接获取用户信息，为了方便起见我们使用yii安装后的默认identitiyClass属性app\models\User  
值得注意的是，identityClass必须实现接口IdentityInterface  
默认的identityClass内部源码非常简单  
```
private static $users = [
    '100' => [
        'id' => '100',
        'username' => 'admin',
        'password' => 'admin',
        'authKey' => 'test100key',
        'accessToken' => '100-token',
    ],
    '101' => [
        'id' => '101',
        'username' => 'demo',
        'password' => 'demo',
        'authKey' => 'test101key',
        'accessToken' => '101-token',
    ],
];
//通过id获取用户信息，就是静态user属性的key
public static function findIdentity($id)
{
    return isset(self::$users[$id]) ? new static(self::$users[$id]) : null;
}
//通过accessToken获取用户信息
public static function findIdentityByAccessToken($token, $type = null)
{
    foreach (self::$users as $user) {
        if ($user['accessToken'] === $token) {
            return new static($user);
        }
    }

    return null;
}
//通过用户名获取用户属性，默认是不区分大小写的
public static function findByUsername($username)
{
    foreach (self::$users as $user) {
        if (strcasecmp($user['username'], $username) === 0) {
            return new static($user);
        }
    }

    return null;
}
//判断authKey是否一致
public function validateAuthKey($authKey)
{
    return $this->authKey === $authKey;
}
//判断密码是否一致
public function validatePassword($password)
{
    return $this->password === $password;
}
```
# 用户信息注册进认证组件源码
先从用户登录开始，控制器代码如下  
```
class TestController extends Controller{
  public function actionD(){
      $user = Yii::$app->get("user");
      //使用安装yii后默认的models\User
      $identity = $user->identityClass::findIdentity(101);
      //将用户信息注册进用户认证
      $user->login($identity);
  }
}
```
